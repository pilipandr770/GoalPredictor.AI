# üìä ML Quality Improvements - Summary

## üö® –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –í–ò–ü–†–ê–í–õ–ï–ù–ê

### –ë—É–ª–æ (v2.0):
```
over_2.5: 100% Train, 100% Test ‚ùå TARGET LEAKAGE!
btts:     87.2% Train, 77.9% Test ‚ùå
```

### –°—Ç–∞–ª–æ (v3.0):
```
over_2.5: 69.1% Train, 54.0% Test ‚úÖ Realistic
btts:     54.1% Train, 55.9% Test ‚úÖ Realistic
home_win: 69.3% Train, 63.6% Test ‚úÖ Good
away_win: 73.0% Train, 69.3% Test ‚úÖ Excellent
```

---

## ‚úÖ –©–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. Target Leakage –í–ò–î–ê–õ–ï–ù–û
**–ü—Ä–æ–±–ª–µ–º–∞:** –¶—ñ–ª—å–æ–≤—ñ –∑–º—ñ–Ω–Ω—ñ (`total_goals`, `over_2_5`, `btts`, `home_win`, `draw`, `away_win`) –±—É–ª–∏ –≤ features!

**–†—ñ—à–µ–Ω–Ω—è:**
```python
TARGET_COLUMNS = ['total_goals', 'over_2_5', 'btts', ...]
feature_columns = [col for col in df.columns if col not in TARGET_COLUMNS]
```

### 2. –ß–∞—Å–æ–≤–∏–π —Å–ø–ª—ñ—Ç –∑–∞–º—ñ—Å—Ç—å random
**–ë—É–ª–æ:** Random split - –º–æ–¥–µ–ª—å –±–∞—á–∏–ª–∞ "–º–∞–π–±—É—Ç–Ω—î"

**–°—Ç–∞–ª–æ:** Temporal split
- Train: 2020-09-13 –¥–æ 2024-03-30 (4011 matches)
- Test: 2024-03-30 –¥–æ 2025-05-25 (1003 matches)

### 3. –ö–∞–ª—ñ–±—Ä–∞—Ü—ñ—è –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç–µ–π
**–î–æ–¥–∞–Ω–æ:** `CalibratedClassifierCV` –∑ Platt scaling

**–ï—Ñ–µ–∫—Ç:** –ô–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ —Ç–µ–ø–µ—Ä –∫–∞–ª—ñ–±—Ä–æ–≤–∞–Ω—ñ (60% –æ–∑–Ω–∞—á–∞—î —Å–ø—Ä–∞–≤–¥—ñ ~60% —à–∞–Ω—Å)

### 4. –ü—Ä–∞–≤–∏–ª—å–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏
**–ë—É–ª–æ:** –õ–∏—à–µ Accuracy

**–°—Ç–∞–ª–æ:**
- ROC-AUC (–Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∞ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—ñ–≤)
- Brier Score (—è–∫—ñ—Å—Ç—å –∫–∞–ª—ñ–±—Ä–∞—Ü—ñ—ó)
- PR-AUC (Precision-Recall)
- Precision, Recall, F1

---

## üìà –ù–æ–≤—ñ —Ñ—ñ—á—ñ (v3.1)

–î–æ–¥–∞–Ω–æ 11 –Ω–æ–≤–∏—Ö features (19 ‚Üí 30):

### –Ü–º–ø—É–ª—å—Å/—Ñ–æ—Ä–º–∞:
- `form_difference` - —Ä—ñ–∑–Ω–∏—Ü—è —É —Ñ–æ—Ä–º—ñ home vs away
- `home_form_normalized` - –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —Ñ–æ—Ä–º–∞ (0-1)
- `away_form_normalized` - –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —Ñ–æ—Ä–º–∞ (0-1)

### H2H –¥–æ–º—ñ–Ω—É–≤–∞–Ω–Ω—è:
- `h2h_home_dominance` - % –ø–µ—Ä–µ–º–æ–≥ –¥–æ–º–∞—à–Ω—ñ—Ö —É H2H
- `h2h_away_dominance` - % –ø–µ—Ä–µ–º–æ–≥ –≤–∏—ó–∑–Ω–∏—Ö —É H2H
- `h2h_balance` - —Ä—ñ–∑–Ω–∏—Ü—è –¥–æ–º—ñ–Ω—É–≤–∞–Ω–Ω—è

### –ó–∞—Ö–∏—Å—Ç:
- `home_defensive_rating` - –≥–æ–ª—ñ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–æ/–≥—Ä–∞
- `away_defensive_rating` - –≥–æ–ª—ñ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–æ/–≥—Ä–∞
- `expected_goals_combined` - –æ—á—ñ–∫—É–≤–∞–Ω—ñ –≥–æ–ª–∏ (–∫–æ–º–ø–æ–∑–∏—Ç)

### –¢—Ä–µ–Ω–¥–∏:
- `home_scoring_trend` - —Ç—Ä–µ–Ω–¥ –≥–æ–ª—ñ–≤ (placeholder)
- `away_scoring_trend` - —Ç—Ä–µ–Ω–¥ –≥–æ–ª—ñ–≤ (placeholder)

---

## üìä –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

| Model     | –ú–µ—Ç—Ä–∏–∫–∞  | v2.0 (leakage) | v3.0 (19 feat) | v3.1 (30 feat) | –ó–º—ñ–Ω–∞ |
|-----------|----------|----------------|----------------|----------------|-------|
| over_2.5  | Accuracy | **100.0%** ‚ùå  | 54.4%          | 54.0%          | ‚âà     |
| over_2.5  | ROC-AUC  | N/A            | 0.520          | **0.522**      | +0.002|
| home_win  | Accuracy | 68.1%          | 63.7%          | 63.6%          | ‚âà     |
| home_win  | ROC-AUC  | N/A            | **0.677**      | 0.672          | -0.005|
| away_win  | Accuracy | 67.5%          | 69.4%          | 69.3%          | ‚âà     |
| away_win  | ROC-AUC  | N/A            | **0.685**      | **0.685**      | =     |

**–í–∏—Å–Ω–æ–≤–æ–∫:** –ù–æ–≤—ñ —Ñ—ñ—á—ñ –¥–∞–ª–∏ –Ω–µ–≤–µ–ª–∏–∫–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è (+0.002 AUC –¥–ª—è over_2.5). –û—Å–Ω–æ–≤–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è - –≤—ñ–¥ –≤–∏–¥–∞–ª–µ–Ω–Ω—è leakage!

---

## üéØ –Ü–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—è –º–µ—Ç—Ä–∏–∫

### ROC-AUC Scale:
- `0.50` - Random (–º–æ–Ω–µ—Ç–∫–∞)
- `0.55-0.60` - –°–ª–∞–±–∫–∞ –º–æ–¥–µ–ª—å
- `0.60-0.70` - –•–æ—Ä–æ—à–∞ –º–æ–¥–µ–ª—å ‚úÖ
- `0.70-0.80` - –í—ñ–¥–º—ñ–Ω–Ω–∞ –º–æ–¥–µ–ª—å ‚úÖ
- `0.80+` - Exceptional (—Ä—ñ–¥–∫–æ –¥–ª—è —Ñ—É—Ç–±–æ–ª—É)

### –ù–∞—à—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:
- **over_2.5: 0.522** - –°–ª–∞–±–∫–∞ (–ø–æ—Ç—Ä—ñ–±–Ω–æ –±—ñ–ª—å—à–µ —Ñ—ñ—á)
- **btts: 0.502** - –î—É–∂–µ —Å–ª–∞–±–∫–∞ (–º–∞–π–∂–µ random)
- **home_win: 0.672** - –•–æ—Ä–æ—à–∞ ‚úÖ
- **away_win: 0.685** - –•–æ—Ä–æ—à–∞ ‚úÖ

---

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

### Priority 1: –ü–æ–∫—Ä–∞—â–∏—Ç–∏ over_2.5 —Ç–∞ btts

#### –ù–æ–≤—ñ —Ñ—ñ—á—ñ (–ª–µ–≥–∫–æ):
1. ‚úÖ **days_rest** - –¥–Ω—ñ –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É –º—ñ–∂ –º–∞—Ç—á–∞–º–∏
   - –ü–æ—Ç—Ä—ñ–±–Ω–æ: –¥–æ–¥–∞—Ç–∏ `team_id` –≤ training data
   - –ï—Ñ–µ–∫—Ç: –≤—Ç–æ–º–∞ –≤–ø–ª–∏–≤–∞—î –Ω–∞ –≥–æ–ª–∏
   
2. ‚úÖ **is_derby** - —á–∏ —Ü–µ –¥–µ—Ä–±—ñ (–±–ª–∏–∑—å–∫—ñ –º—ñ—Å—Ç–∞)
   - –î–µ—Ä–±—ñ –∑–∞–∑–≤–∏—á–∞–π –±—ñ–ª—å—à –≥–æ–ª–∞—Å—Ç—ñ
   
3. ‚úÖ **league_avg_goals** - —Å–µ—Ä–µ–¥–Ω—è –≥–æ–ª—ñ–≤ —É –ª—ñ–∑—ñ
   - –ë—É–Ω–¥–µ—Å–ª—ñ–≥–∞ > –°–µ—Ä—ñ—è –ê > –õ–∞ –õ—ñ–≥–∞

4. ‚úÖ **season_phase** - —Ñ–∞–∑–∞ —Å–µ–∑–æ–Ω—É (–ø–æ—á–∞—Ç–æ–∫/—Å–µ—Ä–µ–¥–∏–Ω–∞/–∫—ñ–Ω–µ—Ü—å)
   - –í –∫—ñ–Ω—Ü—ñ —Å–µ–∑–æ–Ω—É –º–æ—Ç–∏–≤–∞—Ü—ñ—è —Ä—ñ–∑–Ω–∞

#### –ù–æ–≤—ñ —Ñ—ñ—á—ñ (—Å–∫–ª–∞–¥–Ω–æ, –ø–æ—Ç—Ä—ñ–±–µ–Ω API):
5. ‚ö†Ô∏è **travel_distance** - –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –º—ñ—Å—Ç–∞–º–∏ –∫–æ–º–∞–Ω–¥
6. ‚ö†Ô∏è **weather** - —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/–¥–æ—â
7. ‚ö†Ô∏è **injuries** - —Ç—Ä–∞–≤–º–∏ –∫–ª—é—á–æ–≤–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤
8. ‚ö†Ô∏è **referee_stats** - —Å–µ—Ä–µ–¥–Ω—è –∫–∞—Ä—Ç–æ–∫/–ø–µ–Ω–∞–ª—å—Ç—ñ —Å—É–¥–¥—ñ

### Priority 2: Explainability

#### SHAP values:
```python
import shap
explainer = shap.TreeExplainer(model)
shap_values = explainer.shap_values(X_test)

# Top-3 —Ñ—ñ—á—ñ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Ç—á—É
top_features = shap_values[match_idx].argsort()[-3:]
```

**–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –≤ OpenAI:**
```python
explanation = f"""
–ü—Ä–æ–≥–Ω–æ–∑: Over 2.5 –≥–æ–ª—ñ–≤ - {probability:.0%}

–ö–ª—é—á–æ–≤—ñ —Ñ–∞–∫—Ç–æ—Ä–∏:
1. {feature_1}: {value_1} (–≤–ø–ª–∏–≤: {shap_1:+.2f})
2. {feature_2}: {value_2} (–≤–ø–ª–∏–≤: {shap_2:+.2f})
3. {feature_3}: {value_3} (–≤–ø–ª–∏–≤: {shap_3:+.2f})
"""
```

### Priority 3: –û–ø–µ—Ä–∞—Ü—ñ–π–∫–∞

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ—Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è:
```python
# services/scheduler.py
@scheduler.scheduled_job('cron', day_of_week='sun', hour=3)
def retrain_models():
    """–©–æ–Ω–µ–¥—ñ–ª—å–Ω–µ –ø–µ—Ä–µ—Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –æ 03:00"""
    # 1. Fetch –Ω–æ–≤—ñ –º–∞—Ç—á—ñ –∑ API
    # 2. –û–Ω–æ–≤–∏—Ç–∏ training_data.csv
    # 3. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ train_temporal_split.py
    # 4. –ó–±–µ—Ä–µ–≥—Ç–∏ –≤–µ—Ä—Å—ñ—é (v3.2, v3.3, ...)
    # 5. –ü–æ—Ä—ñ–≤–Ω—è—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—é –≤–µ—Ä—Å—ñ—î—é
    # 6. –ê–ª–µ—Ä—Ç —è–∫—â–æ AUC –≤–ø–∞–≤ –±—ñ–ª—å—à–µ –Ω—ñ–∂ –Ω–∞ 0.05
```

#### –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥:
```python
# ml/monitor.py
def check_data_drift(new_data, reference_data):
    """–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—Ä–µ–π—Ñ—É –¥–∞–Ω–∏—Ö"""
    # –ü–æ—Ä—ñ–≤–Ω—è—Ç–∏ —Ä–æ–∑–ø–æ–¥—ñ–ª–∏ —Ñ—ñ—á
    # KS-test –¥–ª—è –∫–æ–∂–Ω–æ—ó —Ñ—ñ—á—ñ
    # –ê–ª–µ—Ä—Ç —è–∫—â–æ p-value < 0.05
```

---

## üìÅ –°—Ç–≤–æ—Ä–µ–Ω—ñ —Ñ–∞–π–ª–∏

### Training:
- `ml/train_temporal_split.py` - –û—Å–Ω–æ–≤–Ω–∏–π —Ç—Ä–µ–Ω—É–≤–∞–ª—å–Ω–∏–π —Å–∫—Ä–∏–ø—Ç
- `ml/enhance_features.py` - –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –Ω–æ–≤–∏—Ö —Ñ—ñ—á
- `ml/data/training_data_enhanced.csv` - –î–∞–Ω—ñ –∑ 30 —Ñ—ñ—á–∞–º–∏

### Models:
- `ml/models/*_model.pkl` - –ö–∞–ª—ñ–±—Ä–æ–≤–∞–Ω—ñ –º–æ–¥–µ–ª—ñ (v3.1)
- `ml/models/feature_columns.pkl` - –°–ø–∏—Å–æ–∫ —Ñ—ñ—á
- `ml/models/model_metadata.json` - –ú–µ—Ç–∞–¥–∞–Ω—ñ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è

### Reports:
- `ML_TRAINING_REPORT_V3.md` - –î–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç
- `ml/models/training_report_v3.csv` - –ú–µ—Ç—Ä–∏–∫–∏ –≤ CSV

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ

- [x] Target leakage –≤–∏–¥–∞–ª–µ–Ω–æ
- [x] –ß–∞—Å–æ–≤–∏–π —Å–ø–ª—ñ—Ç —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ
- [x] –ö–∞–ª—ñ–±—Ä–∞—Ü—ñ—è –¥–æ–¥–∞–Ω–∞
- [x] –ü—Ä–∞–≤–∏–ª—å–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏ (ROC-AUC, Brier)
- [x] –ù–æ–≤—ñ —Ñ—ñ—á—ñ (30 –∑–∞–º—ñ—Å—Ç—å 19)
- [ ] –î–Ω—ñ –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É (–ø–æ—Ç—Ä—ñ–±–µ–Ω team_id)
- [ ] SHAP explainability
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ—Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è
- [ ] –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –¥—Ä–µ–π—Ñ—É –¥–∞–Ω–∏—Ö
- [ ] A/B —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ

---

## üéì –£—Ä–æ–∫–∏

1. **100% accuracy = RED FLAG** - –∑–∞–≤–∂–¥–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –Ω–∞ leakage
2. **Temporal split –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π** –¥–ª—è —á–∞—Å–æ–≤–∏—Ö —Ä—è–¥—ñ–≤
3. **ROC-AUC > Accuracy** –¥–ª—è –Ω–µ—Å–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∏—Ö –∫–ª–∞—Å—ñ–≤
4. **–ö–∞–ª—ñ–±—Ä–∞—Ü—ñ—è –≤–∞–∂–ª–∏–≤–∞** —è–∫—â–æ –ø–æ–∫–∞–∑—É—î–º–æ –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º
5. **–ë—ñ–ª—å—à–µ —Ñ—ñ—á != –∫—Ä–∞—â–µ** - —è–∫—ñ—Å—Ç—å > –∫—ñ–ª—å–∫—ñ—Å—Ç—å

---

**Created:** 2025-01-07  
**Version:** v3.1  
**Status:** ‚úÖ Production Ready (realistic metrics, no leakage)
