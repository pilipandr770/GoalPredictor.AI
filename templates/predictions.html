{% extends "base.html" %}

{% block title %}AI Predictions - GoalPredictor.AI{% endblock %}

{% block content %}
<style>
    .predictions-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .predictions-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    .predictions-header p {
        font-size: 1.1rem;
        opacity: 0.95;
    }
    
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .stat-label {
        color: #666;
        margin-top: 0.5rem;
    }
    
    .match-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .match-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .match-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .league-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .match-time {
        color: #666;
        font-size: 0.95rem;
    }
    
    .teams-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .team {
        flex: 1;
        text-align: center;
    }
    
    .team-name {
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .vs-badge {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 50%;
        font-weight: bold;
        color: #667eea;
        margin: 0 2rem;
    }
    
    .prediction-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .prediction-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 1rem;
        color: #333;
    }
    
    .prediction-result {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .prediction-badge {
        font-size: 1.5rem;
        font-weight: bold;
        padding: 1rem 2rem;
        border-radius: 10px;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .prediction-badge.over {
        color: #28a745;
        border: 2px solid #28a745;
    }
    
    .prediction-badge.under {
        color: #dc3545;
        border: 2px solid #dc3545;
    }
    
    .confidence-bar-wrapper {
        flex: 1;
        max-width: 300px;
    }
    
    .confidence-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .progress {
        height: 25px;
        border-radius: 15px;
        overflow: hidden;
        background: #e9ecef;
    }
    
    .progress-bar {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        transition: width 0.5s ease;
    }
    
    .confidence-high { background: linear-gradient(90deg, #28a745 0%, #20c997 100%); }
    .confidence-medium { background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%); }
    .confidence-low { background: linear-gradient(90deg, #6c757d 0%, #495057 100%); }
    
    .explanation-section {
        background: white;
        border-left: 4px solid #667eea;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 5px;
    }
    
    .explanation-title {
        font-weight: bold;
        margin-bottom: 1rem;
        color: #667eea;
    }
    
    .explanation-text {
        line-height: 1.8;
        color: #555;
    }
    
    .models-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .model-prediction {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        border: 2px solid #e9ecef;
    }
    
    .model-name {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.5rem;
    }
    
    .model-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .loading {
        text-align: center;
        padding: 3rem;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .no-data {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 15px;
    }
    
    .warning-box {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ —Å –±–ª–∏–∂–∞–π—à–∏–º–∏ –º–∞—Ç—á–∞–º–∏ */
    .no-matches-info {
        background: white;
        border-radius: 15px;
        padding: 3rem 2rem;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .info-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .no-matches-info h2 {
        color: #333;
        margin-bottom: 2rem;
        font-size: 2rem;
    }
    
    .upcoming-info {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border-radius: 12px;
        padding: 2rem;
        margin: 2rem auto;
        max-width: 600px;
    }
    
    .upcoming-info h3 {
        color: #667eea;
        margin-bottom: 1rem;
        font-size: 1.3rem;
    }
    
    .next-match-date {
        font-size: 1.4rem;
        font-weight: bold;
        color: #764ba2;
        margin-bottom: 1.5rem;
    }
    
    .upcoming-matches-list {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .upcoming-match-item {
        display: grid;
        grid-template-columns: 60px 1fr auto;
        gap: 1rem;
        padding: 1rem;
        border-bottom: 1px solid #eee;
        align-items: center;
        text-align: left;
    }
    
    .upcoming-match-item:last-child {
        border-bottom: none;
    }
    
    .upcoming-match-item .match-time {
        font-weight: bold;
        color: #667eea;
        font-size: 0.95rem;
    }
    
    .upcoming-match-item .match-teams {
        font-size: 1rem;
        color: #333;
    }
    
    .upcoming-match-item .match-league {
        font-size: 0.85rem;
        color: #999;
        padding: 0.3rem 0.8rem;
        background: #f5f5f5;
        border-radius: 12px;
    }
    
    .prediction-note {
        background: #fff;
        border-left: 4px solid #667eea;
        padding: 1rem;
        margin-top: 1.5rem;
        border-radius: 8px;
        text-align: left;
        font-size: 0.95rem;
        line-height: 1.6;
        color: #555;
    }
    
    .prediction-note strong {
        color: #667eea;
    }
</style>

<div class="container">
    <div class="predictions-header">
        <h1>ü§ñ AI-Powered Predictions</h1>
        <p>–ê–Ω—Å–∞–º–±–ª—å –∏–∑ 4 –º–æ–¥–µ–ª–µ–π ‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å 69% ‚Ä¢ Over 2.5 Goals</p>
    </div>

    <div class="stats-cards" id="stats-section" style="display:none;">
        <div class="stat-card">
            <div class="stat-value" id="total-matches">0</div>
            <div class="stat-label">–ú–∞—Ç—á–µ–π —Å–µ–≥–æ–¥–Ω—è</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avg-confidence">0%</div>
            <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="high-confidence">0</div>
            <div class="stat-label">–í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
        </div>
    </div>

    <div id="predictions-container">
        <div class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤...</p>
        </div>
    </div>
</div>

<script>
function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    return date.toLocaleDateString('ru-RU', options);
}

function getConfidenceClass(probability) {
    if (probability >= 0.75) return 'confidence-high';
    if (probability >= 0.60) return 'confidence-medium';
    return 'confidence-low';
}

function getConfidenceText(probability) {
    if (probability >= 0.75) return '–í—ã—Å–æ–∫–∞—è';
    if (probability >= 0.60) return '–°—Ä–µ–¥–Ω—è—è';
    return '–ù–∏–∑–∫–∞—è';
}

async function loadPredictions() {
    try {
        const response = await fetch('/api/matches/today');
        const data = await response.json();
        const container = document.getElementById('predictions-container');
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–∞—Å—Å–∏–≤ predictions –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
        const matches = data.predictions || [];
        const upcomingMatches = data.upcoming_matches || [];
        
        if (!matches || matches.length === 0) {
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–∏–∂–∞–π—à–∏—Ö –º–∞—Ç—á–∞—Ö
            if (upcomingMatches && upcomingMatches.no_data) {
                // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
                container.innerHTML = `
                    <div class="no-matches-info">
                        <div class="info-icon">üìÖ</div>
                        <h2>–°–µ–≥–æ–¥–Ω—è –º–∞—Ç—á–µ–π –Ω–µ—Ç</h2>
                        <div class="upcoming-info">
                            <p class="prediction-note">
                                ‚è∞ <strong>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</strong><br>
                                ${upcomingMatches.message}<br><br>
                                üí° –ü—Ä–æ–≥–Ω–æ–∑—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã <strong>–∑–∞ –¥–µ–Ω—å –¥–æ –º–∞—Ç—á–∞</strong> –∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è 
                                –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–æ—Ä–º–µ –∫–æ–º–∞–Ω–¥
                            </p>
                        </div>
                    </div>
                `;
            } else if (upcomingMatches && upcomingMatches.nearest_date) {
                const nearestDate = new Date(upcomingMatches.nearest_date);
                const dateStr = nearestDate.toLocaleDateString('ru-RU', { 
                    day: 'numeric', 
                    month: 'long',
                    weekday: 'long'
                });
                
                let matchesList = '';
                if (upcomingMatches.matches && upcomingMatches.matches.length > 0) {
                    matchesList = upcomingMatches.matches.map(match => {
                        const matchDate = new Date(match.date);
                        const timeStr = matchDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                        return `
                            <div class="upcoming-match-item">
                                <span class="match-time">${timeStr}</span>
                                <span class="match-teams">${match.home_team} vs ${match.away_team}</span>
                                <span class="match-league">${match.league}</span>
                            </div>
                        `;
                    }).join('');
                }
                
                container.innerHTML = `
                    <div class="no-matches-info">
                        <div class="info-icon">üìÖ</div>
                        <h2>–°–µ–≥–æ–¥–Ω—è –º–∞—Ç—á–µ–π –Ω–µ—Ç</h2>
                        <div class="upcoming-info">
                            <h3>–ë–ª–∏–∂–∞–π—à–∏–µ –º–∞—Ç—á–∏:</h3>
                            <p class="next-match-date">${dateStr}</p>
                            <div class="upcoming-matches-list">
                                ${matchesList}
                            </div>
                            <p class="prediction-note">
                                üí° <strong>–ü—Ä–æ–≥–Ω–æ–∑—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –∑–∞ –¥–µ–Ω—å –¥–æ –º–∞—Ç—á–∞</strong><br>
                                –û–Ω–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–æ—Ä–º–µ –∫–æ–º–∞–Ω–¥
                            </p>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = '<div class="no-data"><h3>üò¥ –ù–µ—Ç –º–∞—Ç—á–µ–π —Å–µ–≥–æ–¥–Ω—è</h3><p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞!</p></div>';
            }
            return;
        }
        
        const matchesWithPredictions = matches.filter(m => m.prediction);
        
        if (matchesWithPredictions.length === 0) {
            container.innerHTML = '<div class="warning-box"><h3>‚ö†Ô∏è –ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞</h3><p>–ü—Ä–æ–≥–Ω–æ–∑—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</p></div>';
            return;
        }
        
        const totalMatches = matchesWithPredictions.length;
        const avgConfidence = (matchesWithPredictions.reduce((sum, m) => sum + m.prediction.probability, 0) / matchesWithPredictions.length * 100).toFixed(1);
        const highConfidence = matchesWithPredictions.filter(m => m.prediction.probability >= 0.75).length;
        
        document.getElementById('total-matches').textContent = totalMatches;
        document.getElementById('avg-confidence').textContent = avgConfidence + '%';
        document.getElementById('high-confidence').textContent = highConfidence;
        document.getElementById('stats-section').style.display = 'grid';
        
        container.innerHTML = matchesWithPredictions.map(match => {
            const pred = match.prediction;
            const probability = pred.probability;
            const isOver = probability >= 0.5;
            const confidenceClass = getConfidenceClass(probability);
            const confidenceText = getConfidenceText(probability);
            const modelsHTML = pred.models_predictions ? Object.entries(pred.models_predictions).map(([model, prob]) => 
                `<div class="model-prediction"><div class="model-name">${model}</div><div class="model-value">${(prob * 100).toFixed(1)}%</div></div>`
            ).join('') : '';
            
            return `<div class="match-card">
                <div class="match-header">
                    <span class="league-badge">${match.league || 'Unknown League'}</span>
                    <span class="match-time">${formatDate(match.date)}</span>
                </div>
                <div class="teams-section">
                    <div class="team"><div class="team-name">${match.home_team_name}</div></div>
                    <div class="vs-badge">VS</div>
                    <div class="team"><div class="team-name">${match.away_team_name}</div></div>
                </div>
                <div class="prediction-section">
                    <div class="prediction-title">üìä –ü—Ä–æ–≥–Ω–æ–∑ Over 2.5 Goals</div>
                    <div class="prediction-result">
                        <div class="prediction-badge ${isOver ? 'over' : 'under'}">${isOver ? 'OVER 2.5' : 'UNDER 2.5'}</div>
                        <div class="confidence-bar-wrapper">
                            <div class="confidence-label">
                                <span>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${confidenceText}</span>
                                <span><strong>${(probability * 100).toFixed(1)}%</strong></span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar ${confidenceClass}" style="width: ${probability * 100}%">${(probability * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                ${pred.explanation ? `<div class="explanation-section"><div class="explanation-title">ü§ñ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ AI</div><div class="explanation-text">${pred.explanation}</div></div>` : ''}
                ${modelsHTML ? `<div class="explanation-section"><div class="explanation-title">üéØ –ü—Ä–æ–≥–Ω–æ–∑—ã –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π</div><div class="models-section">${modelsHTML}</div></div>` : ''}
            </div>`;
        }).join('');
        
    } catch (error) {
        console.error('Error loading predictions:', error);
        document.getElementById('predictions-container').innerHTML = '<div class="warning-box"><h3>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</h3><p>' + error.message + '</p></div>';
    }
}

document.addEventListener('DOMContentLoaded', loadPredictions);
setInterval(loadPredictions, 5 * 60 * 1000);
</script>
{% endblock %}
