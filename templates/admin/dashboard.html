{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - GoalPredictor.AI{% endblock %}

{% block content %}
<style>
    .admin-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .admin-header h1 {
        font-size: 2rem;
        margin: 0;
    }
    
    .admin-header .user-info {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .stat-icon {
        font-size: 3rem;
        width: 70px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
    }
    
    .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.premium { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-icon.revenue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-icon.predictions { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    
    .stat-content h3 {
        margin: 0;
        font-size: 2rem;
        color: #333;
    }
    
    .stat-content p {
        margin: 0.25rem 0 0;
        color: #666;
        font-size: 0.9rem;
    }
    
    .data-section {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .section-header h2 {
        font-size: 1.5rem;
        margin: 0;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-secondary {
        background: #e9ecef;
        color: #333;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .search-box {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .search-box input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    thead {
        background: #f8f9fa;
    }
    
    th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
    }
    
    td {
        padding: 1rem;
        border-bottom: 1px solid #e0e0e0;
    }
    
    tr:hover {
        background: #f8f9fa;
    }
    
    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .badge-premium {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .badge-free {
        background: #e9ecef;
        color: #666;
    }
    
    .badge-admin {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .loading {
        text-align: center;
        padding: 3rem;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.85rem;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }
    
    .pagination button {
        padding: 0.5rem 1rem;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .pagination button.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<div class="admin-container">
    <div class="admin-header">
        <div>
            <h1>üõ†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</p>
        </div>
        <div class="user-info">
            <p>–í—Ö–æ–¥: <strong id="admin-username">Admin</strong></p>
            <a href="/api/auth/logout" style="color: white;">–í—ã–π—Ç–∏</a>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon users">üë•</div>
            <div class="stat-content">
                <h3 id="total-users">0</h3>
                <p>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon premium">‚≠ê</div>
            <div class="stat-content">
                <h3 id="premium-users">0</h3>
                <p>Premium –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon revenue">üí∞</div>
            <div class="stat-content">
                <h3 id="total-revenue">$0</h3>
                <p>–û–±—â–∏–π –¥–æ—Ö–æ–¥ (–ø—Ä–∏–º–µ—Ä–Ω—ã–π)</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon predictions">üìä</div>
            <div class="stat-content">
                <h3 id="total-predictions">0</h3>
                <p>–í—Å–µ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤</p>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="data-section">
        <div class="section-header">
            <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
            <button class="btn btn-primary" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        
        <div class="search-box">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ email –∏–ª–∏ –∏–º–µ–Ω–∏...">
            <select id="filter-type" class="btn btn-secondary">
                <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                <option value="premium">Premium</option>
                <option value="free">Free</option>
                <option value="admin">–ê–¥–º–∏–Ω—ã</option>
            </select>
        </div>
        
        <div id="users-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
    <div class="data-section">
        <div class="section-header">
            <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h2>
        </div>
        
        <div id="subscriptions-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫...</p>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let allUsers = [];

async function loadStats() {
    try {
        const response = await fetch('/api/admin/stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('total-users').textContent = data.stats.total_users;
            document.getElementById('premium-users').textContent = data.stats.premium_users;
            document.getElementById('total-revenue').textContent = '$' + data.stats.estimated_revenue.toFixed(0);
            document.getElementById('total-predictions').textContent = data.stats.total_predictions;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users');
        const data = await response.json();
        
        if (data.success) {
            allUsers = data.users;
            renderUsers(allUsers);
        }
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('users-container').innerHTML = '<p style="text-align:center; color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
    }
}

function renderUsers(users) {
    const container = document.getElementById('users-container');
    
    if (users.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    const html = `
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ò–º—è</th>
                        <th>Email</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ü—Ä–æ–≥–Ω–æ–∑–æ–≤</th>
                        <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    ${users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>
                                ${user.is_admin ? '<span class="badge badge-admin">–ê–¥–º–∏–Ω</span>' : ''}
                                ${user.is_premium ? '<span class="badge badge-premium">Premium</span>' : '<span class="badge badge-free">Free</span>'}
                            </td>
                            <td>${user.daily_predictions_count || 0}</td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>${user.last_login ? formatDate(user.last_login) : '–ù–∏–∫–æ–≥–¥–∞'}</td>
                            <td>
                                <div class="action-buttons">
                                    ${!user.is_premium ? `<button class="btn btn-sm btn-success" onclick="upgradeToPremium(${user.id})">‚≠ê Premium</button>` : ''}
                                    ${!user.is_admin ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

async function loadSubscriptions() {
    try {
        const response = await fetch('/api/admin/subscriptions');
        const data = await response.json();
        
        if (data.success && data.subscriptions.length > 0) {
            const html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>Email</th>
                                <th>–¢–∏–ø</th>
                                <th>–ù–∞—á–∞–ª–æ</th>
                                <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.subscriptions.map(sub => `
                                <tr>
                                    <td>${sub.username}</td>
                                    <td>${sub.email}</td>
                                    <td>${sub.subscription_type || 'N/A'}</td>
                                    <td>${formatDate(sub.created_at)}</td>
                                    <td>${sub.subscription_end ? formatDate(sub.subscription_end) : 'N/A'}</td>
                                    <td><span class="badge badge-premium">–ê–∫—Ç–∏–≤–Ω–∞</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('subscriptions-container').innerHTML = html;
        } else {
            document.getElementById('subscriptions-container').innerHTML = '<p style="text-align:center; color:#666;">–ü–æ–¥–ø–∏—Å–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
        }
    } catch (error) {
        console.error('Error loading subscriptions:', error);
        document.getElementById('subscriptions-container').innerHTML = '<p style="text-align:center; color:#dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫</p>';
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'short', day: 'numeric' });
}

async function upgradeToPremium(userId) {
    if (!confirm('–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å Premium –ø–æ–¥–ø–∏—Å–∫—É —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?')) return;
    
    try {
        const response = await fetch(`/api/admin/users/${userId}/upgrade`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ Premium');
            refreshData();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
    }
}

async function deleteUser(userId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) return;
    
    try {
        const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
            refreshData();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }
}

function refreshData() {
    loadStats();
    loadUsers();
    loadSubscriptions();
}

// –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
document.getElementById('search-input').addEventListener('input', (e) => {
    const search = e.target.value.toLowerCase();
    const filter = document.getElementById('filter-type').value;
    
    let filtered = allUsers.filter(user => {
        const matchesSearch = user.email.toLowerCase().includes(search) || 
                            user.username.toLowerCase().includes(search);
        
        if (filter === 'all') return matchesSearch;
        if (filter === 'premium') return matchesSearch && user.is_premium;
        if (filter === 'free') return matchesSearch && !user.is_premium;
        if (filter === 'admin') return matchesSearch && user.is_admin;
        
        return matchesSearch;
    });
    
    renderUsers(filtered);
});

document.getElementById('filter-type').addEventListener('change', () => {
    document.getElementById('search-input').dispatchEvent(new Event('input'));
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    refreshData();
});
</script>
{% endblock %}
