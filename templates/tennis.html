{% extends "base.html" %}

{% block title %}Tennis-Prognosen - GoalPredictor.AI{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h1 class="mb-2">
                        <span class="me-2">üéæ</span>
                        Tennis-Prognosen
                    </h1>
                    <p class="text-muted mb-0">
                        KI-gest√ºtzte Vorhersagen f√ºr ATP- und WTA-Matches
                    </p>
                </div>
                
                {% if not current_user.is_premium %}
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-crown me-2"></i>
                    <strong>Premium erforderlich</strong>
                    <p class="mb-2">Tennis-Prognosen sind nur f√ºr Premium-Mitglieder verf√ºgbar.</p>
                    <a href="/pricing" class="btn btn-sm btn-warning">
                        <i class="fas fa-arrow-up me-1"></i>
                        Jetzt upgraden
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Demo Mode Notice -->
    <div id="demoModeNotice" class="row mb-4" style="display: none;">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-info-circle fa-2x me-3"></i>
                <div>
                    <strong>Demo-Modus aktiv</strong>
                    <p class="mb-1">
                        Derzeit werden Test-Matches angezeigt. Um echte ATP/WTA Spielpl√§ne zu sehen:
                    </p>
                    <ol class="mb-0 ps-3">
                        <li>Registrieren Sie sich kostenlos bei <a href="https://rapidapi.com/jjrm365-kIFr3Nx_odV/api/tennis-api-atp-wta-itf" target="_blank">RapidAPI</a> (100 Anfragen/Monat gratis)</li>
                        <li>Kopieren Sie Ihren API-Schl√ºssel</li>
                        <li>F√ºgen Sie ihn in die <code>.env</code> Datei ein: <code>RAPIDAPI_TENNIS_KEY=ihr-schl√ºssel</code></li>
                        <li>Starten Sie die Anwendung neu</li>
                    </ol>
                    <a href="https://github.com/pilipandr770/GoalPredictor.AI/blob/master/TENNIS_API_SETUP.md" target="_blank" class="btn btn-sm btn-info mt-2">
                        <i class="fas fa-book me-1"></i>
                        Vollst√§ndige Anleitung
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Zeitraum</label>
                            <select id="daysFilter" class="form-select">
                                <option value="1">Heute</option>
                                <option value="3">N√§chste 3 Tage</option>
                                <option value="7" selected>N√§chste Woche</option>
                                <option value="14">N√§chste 2 Wochen</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Belag</label>
                            <select id="surfaceFilter" class="form-select">
                                <option value="">Alle Bel√§ge</option>
                                <option value="Hard">Hartplatz</option>
                                <option value="Clay">Sand</option>
                                <option value="Grass">Rasen</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Turnier</label>
                            <select id="tournamentFilter" class="form-select">
                                <option value="">Alle Turniere</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button id="refreshBtn" class="btn btn-primary w-100">
                                <i class="fas fa-sync-alt me-2"></i>
                                Aktualisieren
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">L√§dt...</span>
        </div>
        <p class="text-muted">Lade Tennis-Matches...</p>
    </div>

    <!-- No Matches State -->
    <div id="noMatchesState" class="text-center py-5" style="display: none;">
        <div class="mb-4">
            <i class="fas fa-calendar-times fa-4x text-muted"></i>
        </div>
        <h3>Keine Matches gefunden</h3>
        <p class="text-muted">
            F√ºr den ausgew√§hlten Zeitraum sind keine Tennis-Matches verf√ºgbar.
        </p>
    </div>

    <!-- Matches List -->
    <div id="matchesList" class="row">
        <!-- Will be populated by JavaScript -->
    </div>
</div>

<!-- Match Prediction Modal -->
<div class="modal fade" id="predictionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="me-2">üéæ</span>
                    Match-Prognose
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="predictionContent">
                <!-- Will be populated by JavaScript -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">L√§dt...</span>
                    </div>
                    <p class="mt-3 text-muted">Generiere Prognose...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.match-card {
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
    height: 100%;
}

.match-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.player-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
}

.player-rank {
    display: inline-block;
    background: #f8f9fa;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    color: #6c757d;
}

.player-rank.top10 {
    background: #ffd700;
    color: #000;
    font-weight: 600;
}

.surface-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.surface-hard {
    background: #3498db;
    color: white;
}

.surface-clay {
    background: #e74c3c;
    color: white;
}

.surface-grass {
    background: #27ae60;
    color: white;
}

.probability-bar {
    height: 8px;
    border-radius: 4px;
    background: #e9ecef;
    overflow: hidden;
    margin-top: 8px;
}

.probability-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.3s;
}

.confidence-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
}

.confidence-high {
    background: #d4edda;
    color: #155724;
}

.confidence-medium {
    background: #fff3cd;
    color: #856404;
}

.confidence-low {
    background: #f8d7da;
    color: #721c24;
}
</style>

<script>
let allMatches = [];
let currentMatchId = null;

// Load matches on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMatches();
    
    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', loadMatches);
    document.getElementById('daysFilter').addEventListener('change', loadMatches);
    document.getElementById('surfaceFilter').addEventListener('change', filterMatches);
    document.getElementById('tournamentFilter').addEventListener('change', filterMatches);
});

async function loadMatches() {
    const days = document.getElementById('daysFilter').value;
    
    // Show loading
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('noMatchesState').style.display = 'none';
    document.getElementById('matchesList').innerHTML = '';
    
    try {
        const response = await fetch(`/api/tennis/matches?days=${days}`);
        const data = await response.json();
        
        if (data.success && data.matches && data.matches.length > 0) {
            allMatches = data.matches;
            
            // Check if demo mode is active (match IDs start with 'demo_')
            const isDemoMode = data.matches.every(m => m.id && m.id.startsWith('demo_'));
            document.getElementById('demoModeNotice').style.display = isDemoMode ? 'block' : 'none';
            
            populateTournamentFilter();
            filterMatches();
        } else {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('noMatchesState').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading matches:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('noMatchesState').style.display = 'block';
    }
}

function populateTournamentFilter() {
    const tournaments = [...new Set(allMatches.map(m => m.tournament))];
    const select = document.getElementById('tournamentFilter');
    
    // Clear and add "All" option
    select.innerHTML = '<option value="">Alle Turniere</option>';
    
    // Add tournament options
    tournaments.forEach(tournament => {
        const option = document.createElement('option');
        option.value = tournament;
        option.textContent = tournament;
        select.appendChild(option);
    });
}

function filterMatches() {
    const surfaceFilter = document.getElementById('surfaceFilter').value;
    const tournamentFilter = document.getElementById('tournamentFilter').value;
    
    let filtered = allMatches;
    
    if (surfaceFilter) {
        filtered = filtered.filter(m => m.surface === surfaceFilter);
    }
    
    if (tournamentFilter) {
        filtered = filtered.filter(m => m.tournament === tournamentFilter);
    }
    
    displayMatches(filtered);
}

function displayMatches(matches) {
    document.getElementById('loadingState').style.display = 'none';
    
    if (matches.length === 0) {
        document.getElementById('noMatchesState').style.display = 'block';
        document.getElementById('matchesList').innerHTML = '';
        return;
    }
    
    document.getElementById('noMatchesState').style.display = 'none';
    
    const matchesList = document.getElementById('matchesList');
    matchesList.innerHTML = '';
    
    matches.forEach(match => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-4';
        col.innerHTML = createMatchCard(match);
        matchesList.appendChild(col);
    });
}

function createMatchCard(match) {
    const date = new Date(match.date);
    const dateStr = date.toLocaleDateString('de-DE', { 
        weekday: 'short', 
        day: '2-digit', 
        month: '2-digit' 
    });
    const timeStr = date.toLocaleTimeString('de-DE', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    const surfaceClass = `surface-${match.surface.toLowerCase()}`;
    
    const p1RankClass = match.player1.rank <= 10 ? 'top10' : '';
    const p2RankClass = match.player2.rank <= 10 ? 'top10' : '';
    
    return `
        <div class="card match-card shadow-sm" onclick="showPrediction('${match.id}')">
            <div class="card-body">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h6 class="mb-1 text-muted">${match.tournament}</h6>
                        <small class="text-muted">${match.round}</small>
                    </div>
                    <span class="surface-badge ${surfaceClass}">
                        ${match.surface}
                    </span>
                </div>
                
                <!-- Players -->
                <div class="mb-3">
                    <!-- Player 1 -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="flex-grow-1">
                            <div class="player-name">${match.player1.name}</div>
                            <span class="player-rank ${p1RankClass}">
                                #${match.player1.rank}
                            </span>
                            ${match.player1.country ? `<span class="ms-2">${match.player1.country}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="text-center my-2">
                        <small class="text-muted">vs</small>
                    </div>
                    
                    <!-- Player 2 -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="player-name">${match.player2.name}</div>
                            <span class="player-rank ${p2RankClass}">
                                #${match.player2.rank}
                            </span>
                            ${match.player2.country ? `<span class="ms-2">${match.player2.country}</span>` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="d-flex justify-content-between align-items-center text-muted">
                    <small>
                        <i class="far fa-calendar me-1"></i>
                        ${dateStr}
                    </small>
                    <small>
                        <i class="far fa-clock me-1"></i>
                        ${timeStr}
                    </small>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary btn-sm w-100" onclick="showPrediction('${match.id}')">
                        <i class="fas fa-chart-line me-2"></i>
                        Prognose anzeigen
                    </button>
                </div>
            </div>
        </div>
    `;
}

const IS_USER_PREMIUM = {% if current_user.is_authenticated %}{{ current_user.is_premium|tojson }}{% else %}false{% endif %};

async function showPrediction(matchId) {
    {% if not current_user.is_authenticated %}
    // Redirect to login
    alert('Bitte melden Sie sich an, um Prognosen zu sehen.');
    // You can show login modal here
    return;
    {% elif not current_user.is_premium %}
    // Redirect to pricing
    window.location.href = '/pricing';
    return;
    {% endif %}
    
    currentMatchId = matchId;
    
    // Show modal with loading
    const modal = new bootstrap.Modal(document.getElementById('predictionModal'));
    modal.show();
    
    document.getElementById('predictionContent').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">L√§dt...</span>
            </div>
            <p class="mt-3 text-muted">Generiere Prognose...</p>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/tennis/predictions/${matchId}`);
        const data = await response.json();
        
        if (data.success) {
            displayPrediction(data.prediction);
        } else {
            document.getElementById('predictionContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || 'Fehler beim Laden der Prognose'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading prediction:', error);
        document.getElementById('predictionContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Fehler beim Laden der Prognose
            </div>
        `;
    }
}

function displayPrediction(prediction) {
    const match = allMatches.find(m => m.id === currentMatchId);
    if (!match) return;
    
    const p1Prob = (prediction.player1_win_probability * 100).toFixed(1);
    const p2Prob = (prediction.player2_win_probability * 100).toFixed(1);
    
    const confidenceClass = `confidence-${prediction.confidence}`;
    const confidenceText = {
        'high': 'Hoch',
        'medium': 'Mittel',
        'low': 'Niedrig'
    }[prediction.confidence] || 'Mittel';
    
    let html = `
        <!-- Match Info -->
        <div class="mb-4 pb-3 border-bottom">
            <h6 class="text-muted mb-2">${match.tournament} - ${match.round}</h6>
            <div class="row">
                <div class="col-5 text-center">
                    <div class="fs-5 fw-bold">${match.player1.name}</div>
                    <small class="text-muted">#${match.player1.rank}</small>
                </div>
                <div class="col-2 text-center">
                    <small class="text-muted">vs</small>
                </div>
                <div class="col-5 text-center">
                    <div class="fs-5 fw-bold">${match.player2.name}</div>
                    <small class="text-muted">#${match.player2.rank}</small>
                </div>
            </div>
        </div>
        
        <!-- Prediction -->
        <div class="mb-4">
            <div class="row text-center">
                <div class="col-5">
                    <div class="display-4 fw-bold text-primary">${p1Prob}%</div>
                    <small class="text-muted">Siegchance</small>
                </div>
                <div class="col-2 d-flex align-items-center justify-content-center">
                    <i class="fas fa-trophy text-warning"></i>
                </div>
                <div class="col-5">
                    <div class="display-4 fw-bold text-secondary">${p2Prob}%</div>
                    <small class="text-muted">Siegchance</small>
                </div>
            </div>
            
            <div class="probability-bar mt-3">
                <div class="probability-fill" style="width: ${p1Prob}%"></div>
            </div>
        </div>
        
        <!-- Confidence -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">Konfidenz:</span>
                <span class="confidence-badge ${confidenceClass}">${confidenceText}</span>
            </div>
        </div>
        
        <!-- Predicted Winner -->
        <div class="alert alert-success mb-4">
            <strong>
                <i class="fas fa-trophy me-2"></i>
                Vorhergesagter Sieger: ${prediction.predicted_winner}
            </strong>
        </div>
        
        <!-- Explanation -->
        <div class="mb-4">
            <h6 class="mb-2">Analyse:</h6>
            <p class="text-muted">${prediction.explanation}</p>
        </div>
        
        <!-- Key Factors -->
        ${prediction.factors && prediction.factors.length > 0 ? `
        <div>
            <h6 class="mb-3">Hauptfaktoren:</h6>
            ${prediction.factors.map(factor => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                    <div>
                        <strong>${factor.factor}</strong>
                        ${factor.description ? `<br><small class="text-muted">${factor.description}</small>` : ''}
                    </div>
                    <span class="badge bg-${factor.impact === 'high' ? 'danger' : factor.impact === 'medium' ? 'warning' : 'secondary'}">
                        ${factor.impact === 'high' ? 'Hoch' : factor.impact === 'medium' ? 'Mittel' : 'Niedrig'}
                    </span>
                </div>
            `).join('')}
        </div>
        ` : ''}
    `;
    
    document.getElementById('predictionContent').innerHTML = html;
}
</script>
{% endblock %}
